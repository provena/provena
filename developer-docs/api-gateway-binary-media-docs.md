# Generate Report Feature - AWS API Gateway and Lambda Issue

## Context:
The **Generate Report** functionality aims to automate a step of the study close-out report process, conducted by modelers and researchers as a part of their modeling investigation. The feature, when successful, generates a Word document that contains associated inputs, model runs, and outputs from a study item.

The current **Provena System** uses FastAPI wrapped around Mangum, which handles the integration with AWS API Gateway and Lambda to serve HTTP requests. This architecture is designed to facilitate serverless deployments. However, during the development of the **Generate Report** functionality, the team encountered challenges specifically related to handling and downloading Word files (binary data) via API Gateway.

In API Gateway, or for any REST API server, the `content-type` within the response headers is crucial to let the client application know how to interpret the data that is being returned. In this feature development, since we are focusing on returning a generated Word document to the client, this typically involves specifying the MIME Type of `application/vnd.openxmlformats-officedocument.wordprocessingml.document`. As you can observe with the code block below, we have specified that exact MIME type within the headers and are returning a binary payload via FastAPI's `FileResponse` Custom Response.

### Generate Report FastAPI Route

```python
generated_doc_path: str = await generate_report_helper(
        node_id=request.id,
        upstream_depth=request.depth,
        item_subtype=request.item_subtype,
        roles=roles,
        config=config
    )

# Add the removal of the generated word doc as a background task.
background_tasks.add_task(remove_file, file_path=generated_doc_path)

# Explicitly set the headers
headers = {
    "Content-Type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "Content-Disposition": 'attachment; filename="Study Close Out Report.docx"',
}

return FileResponse(
    path = generated_doc_path,
    filename= "Study Close Out Report.docx",
    headers = headers
)

```

## The Problem

While implementing the **Generate Report** feature, no issues arose during local development. However, upon deployment, problems were encountered when attempting to download the generated Word document. The file appeared to download correctly, but it could not be opened by any Word processor.

After further investigation, it was discovered that the downloaded Word document was **base64-encoded**. Manually decoding the file and saving its contents restored the original document with all formatting intact.

It was determined that AWS Lambda and API Gateway communicate by passing **base64-encoded data** for binary content. In this case, the Word file was generated by Lambda and base64-encoded before being sent to API Gateway. API Gateway then served the Word file to the client, maintaining the base64 encoding, instead of returning the raw binary data.

This issue occurred due to the API Gateway's **binary media settings** not being configured correctly. These settings specify the accepted content types for binary files (such as `application/pdf` or, in this case, `application/vnd.openxmlformats-officedocument.wordprocessingml.document`). As a result, API Gateway continued serving the base64-encoded content rather than the raw binary file.

## The Solution

The root cause of the issue was identified as the **API Gateway's binary media settings** not being properly configured to handle the specific MIME type for Word documents. By adding `application/vnd.openxmlformats-officedocument.wordprocessingml.document` to the list of accepted binary media types in API Gateway's configuration, API Gateway was instructed to serve raw binary data instead of base64-encoded content if the response content-type included the respective MIME type.

However, even after adding the correct MIME type to the API Gateway's binary media settings, the issue persisted, and the generated Word file was still returned as base64-encoded. Further investigation revealed that, in addition to configuring API Gateway, the **frontend request's Accept header** also needed to explicitly include `application/vnd.openxmlformats-officedocument.wordprocessingml.document`.

Without the Accept header set correctly, API Gateway continued to return the file as base64-encoded, even though the MIME type matched the configuration. By adding the appropriate **Accept header** to the frontend request, API Gateway correctly served the raw binary Word file as intended.

## Conclusion

The issue with the **Generate Report** functionality was caused by incorrect API Gateway binary media settings and a missing ```Accept``` header in the frontend request. Initially, the generated Word document was returned as base64-encoded, preventing it from being opened.

The solution involved:

- Configuring **API Gateway** to accept the MIME type `application/vnd.openxmlformats-officedocument.wordprocessingml.document` for binary content, ensuring raw binary data was returned.

- Setting the **Accept header** on the frontend request to specify the expected Word document format, allowing API Gateway to serve the file correctly.

These changes resolved the issue, enabling the correct download and opening of the Word file.
